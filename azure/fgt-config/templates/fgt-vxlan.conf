%{ if external-ip != "" }
config system vxlan
edit "${vxlan_name}-${vxlan_port}"
set interface ${vxlan_port}
set vni ${vni}
set remote-ip ${external-ip}
next
end
config system interface
edit "${vxlan_name}-${vxlan_port}"
set ip ${local-ip} 255.255.255.240
next
end
%{ endif }

config system zone
edit ${vxlan_name}
%{ if external-ip != "" }
set interface "${vxlan_name}-${vxlan_port}"
%{ endif }
next
end

config router route-map
edit "rm_prepending_out_0"
config rule
edit 1
set match-community "${local_bgp-asn}:1"
set match-community-exact enable
set set-aspath "${local_bgp-asn}"
next
edit 2
set match-community "${local_bgp-asn}:2"
set match-community-exact enable
set set-aspath "${local_bgp-asn} ${local_bgp-asn} ${local_bgp-asn}"
next
edit 3
set set-aspath "${local_bgp-asn}"
next
end
next
edit "rm_prepending_out_1"
config rule
edit 1
set match-community "${local_bgp-asn}:1"
set match-community-exact enable
set set-aspath "${local_bgp-asn} ${local_bgp-asn}"
next
edit 2
set match-community "${local_bgp-asn}:2"
set match-community-exact enable
set set-aspath "${local_bgp-asn} ${local_bgp-asn} ${local_bgp-asn} ${local_bgp-asn}"
next
edit 3
set set-aspath "${local_bgp-asn} ${local_bgp-asn}"
next
end
next
end

config router bgp
set as ${local_bgp-asn}
set router-id ${local_router-id}
set ibgp-multipath enable
set additional-path enable
set graceful-restart enable
set additional-path-select 255
set network-import-check disable
config neighbor
edit ${remote-ip}
set ebgp-enforce-multihop enable
set soft-reconfiguration enable
set interface "${vxlan_name}-${vxlan_port}"
set remote-as ${bgp-asn}
%{ if route_map_out != "" }
set default-originate-routemap ${route_map_out}
set route-map-out ${route_map_out}
%{ endif }
next
end
end

config firewall policy
edit 0
set name "${vpn_name}-to-vxlan"
set srcintf ${vpn_name}
set dstintf ${vxlan_name}
set action accept
set srcaddr "all"
set dstaddr "all"
set schedule "always"
set service "ALL"
set logtraffic all
set nat enable
next
edit 0
set name "vxlan-to-${vpn_name}"
set srcintf ${vxlan_name}
set dstintf ${vpn_name}
set action accept
set srcaddr "all"
set dstaddr "all"
set schedule "always"
set service "ALL"
set logtraffic all
set nat enable
next
edit 0
set name "vxlan-to-private"
set srcintf ${private_port}
set dstintf ${vxlan_name}
set action accept
set srcaddr "all"
set dstaddr "all"
set schedule "always"
set service "ALL"
set logtraffic all
set nat enable
next
edit 0
set name "private-to-vxlan"
set srcintf ${vxlan_name}
set dstintf ${private_port}
set action accept
set srcaddr "all"
set dstaddr "all"
set schedule "always"
set service "ALL"
set logtraffic all
set nat enable
next
end